{
  "id": "YBsAen6BbqpLEU9r",
  "name": "TimeZone",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "contact_id",
              "type": "number"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -464,
        -224
      ],
      "id": "953f8067-7b0b-46a8-9439-04111549a891",
      "name": "start"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- SQL для n8n: обновление TimeZone для контакта\nWITH target_contact AS (\n  SELECT c.*\n  FROM {{ $vars.ncdbid }}.\"Contacts\" AS c\n  WHERE c.id = {{ $node[\"start\"].json[\"contact_id\"] }}\n),\ntimezone_resolution AS (\n  SELECT \n    tc.id,\n    tc.\"TimeZone\" as original_timezone,\n    tc.\"Phone\",\n    ph.digits,\n    -- Проверяем валидность существующего TimeZone\n    tz_ok.tz as valid_tz,\n    -- Находим TimeZone по коду телефона\n    m.tz as phone_tz,\n    -- Выбираем финальный TimeZone\n    COALESCE(\n  tz_ok.tz, \n  m.tz, \n  NULLIF(trim('{{ $env['GENERIC_TIMEZONE'] }}'), ''),\n  'UTC'  -- хардкод fallback на случай, если переменная окружения не задана\n) as final_tz\n  FROM target_contact AS tc\n  -- Нормализуем телефон до цифр\n  CROSS JOIN LATERAL (\n    SELECT regexp_replace(coalesce(tc.\"Phone\", ''), '\\D', '', 'g') AS digits\n  ) ph\n  -- Пытаемся определить TZ по коду телефона\n  LEFT JOIN LATERAL (\n    SELECT tz.\"TimeZone\" AS tz\n    FROM {{ $vars.ncdbid_data }}.\"Code-TimeZones\" AS tz\n    JOIN LATERAL (VALUES (4),(3),(2),(1)) AS lens(len) ON true\n    WHERE tz.\"Code\" = NULLIF(LEFT(ph.digits, lens.len), '')::bigint\n    ORDER BY lens.len DESC\n    LIMIT 1\n  ) m ON true\n  -- Проверяем что TimeZone валиден в Postgres\n  LEFT JOIN LATERAL (\n    SELECT pgtz.name AS tz\n    FROM pg_timezone_names AS pgtz\n    WHERE pgtz.name = trim(tc.\"TimeZone\")\n    LIMIT 1\n  ) tz_ok ON true\n)\n-- Обновляем только если текущий TimeZone не валидный\nUPDATE {{ $vars.ncdbid }}.\"Contacts\" c\nSET \"TimeZone\" = tr.final_tz\nFROM timezone_resolution tr\nWHERE c.id = tr.id\n  AND tr.valid_tz IS NULL  -- обновляем только если текущий timezone не валидный\nRETURNING \n  c.id,\n  c.\"TimeZone\" as new_timezone,\n  tr.original_timezone as old_timezone,\n  tr.\"Phone\" as phone,\n  tr.phone_tz as matched_by_phone;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -240,
        -224
      ],
      "id": "0af885fc-32b7-4689-ba5a-87085f62c026",
      "name": "set timezone",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "oZABCHH2vjfMvXoi",
          "name": "nocodb"
        }
      }
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "set timezone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "uG4YJnnTISaYTXXk"
  },
  "triggerCount": 0,
  "versionId": "6dafce92-f9b5-4552-bf57-323fd53bbe5e",
  "owner": {
    "type": "personal",
    "projectId": "Lz2EaMLn9ckxxJx0",
    "projectName": "City Company <dispatch@citycompany.net>",
    "personalEmail": "dispatch@citycompany.net"
  },
  "parentFolderId": "kK192fbu6GJvHsuJ",
  "isArchived": false
}